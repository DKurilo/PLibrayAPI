dist: bionic
services:
- docker
cache:
  directories:
  - "$HOME/.local/bin"
  - "$HOME/.stack"
  - "$TRAVIS_BUILD_DIR/.stack-work"
addons:
  apt:
    update: true
    packages:
    - libgmp-dev
env:
  global:
    secure: wK2pX57FgGVa3JQbu7OQ3u5W17vgVozCxPsXrR8xtvaeLHE2PnOvZm2YStT6MelVakUsIC2h0xOLDmjgZdz5TGF3nW68XlS6ioI7ti2bAzt9icxKjrM5pmND9GYUS6GVRCZno2XdBA4pNEZABHO8yNJpKb1m645+mchouigvk5CyUkwPOQpD1L5QoCLHxi871hrJbnbh5P2k0SXYMYjTiQt5LJbgdi/hRVBRFXzw0JIrb6qw1EzS+sHl6Stq/fSvP1sT6VxkIgmXTnLKy9gIo+XfV/+PxMHxCUNfuAfUHzGoXEvswnVQoESUdWA9pN8DukjetI5wdtg4DqFd0lVwUrU0zrauK24PgIvn0HQAQr95hmLeX9jVgnhfxD1qLxIl2/9qNVxn5JuyJPF3sm2YnNSWfAeTVPGzgBrYtcBerzIgR17+RLl4B/FBb6UNQy/ljVIybQP3dye5NzyzRYkUlgfYI+gl9Shs3Pg8dWSRB5bsT9l2ju3I02MgsqCojM4RKrzohojTZPSraLQPs41X9iTolJsx7755VsinEygnX3BjLQ94lPFjvdzDSfZnDCifIWdaR/cmrov8TX8Cb9oYsxitguEcPm3Kha+54RZZuqngFAmPlEoVb9k+DXyKwAz912/wvFHyFF2DQaSQMzRfy5pSMFAfVJ7V+xzXr7kzHLs=
    secure: A/HOk2cf41esSvx77b0+/jJ6A9bonVraMxIBpWM5ndniS+mLxREi2+XFOlCJP/IPIKwI02/TdKXfoNQImKvkMlHfF1mpVG86268kgJ8fOxWIT1W9pO8j1gb52GsTWAdha7EWpKfvi8Xt5uaqm+v0KVJKr5LZq4m0A7gUN4CgvYNVkCMZeppiHCmNWJ3cJ7EftkXkd1AbiyzvHsNMfPqkH1CMwcMAwPjNMbyu7IQXQkzEVFnVMVYtJxS2vThHIJn/WigiugE0iMjTqNqyvUFXNhn2IxWjw0kWADXHPrvJFe1ueQfgx62GvStFdNqr8DSWtdeiH1/+5f5QaE7z1Bweh6UseD9WnTmkmTbLRvTssmWxq3z9TkQfPWdDc8ZisKz5rCHLnInZTesj0IEmDlEuA7McPtMbjuIjqYADe7/3PCqwmylewKxyooYGbu4uDN5AyPaU5PPftB6+KfGzjm4SvXiFaoPxYCk4QVQuPnm3atieXrBGLNAUQL6StryvBSFI9F+Yc35lpl7YOqoeAkBKI1XjlAL4FfSHXbNQkuRZ3tD7tVXTmrj2JvQ3+BWu2P7OYGnxLdLXW58d7qpYDZDRc1UilsvgVL+akJ95Zz//UzwxJnqJFKTfiDFIhaert5Lc/gARHVE/5o6zeNFiTPdrnmar4Q2A2uxbeCff/Atc0KU=
jobs:
  include:
  - stage: Install Stack
    script:
    - export DIR=~/.local/bin
    - if [ ! -d "$DIR" ]; then mkdir -p ~/.local/bin; fi
    - export PATH=$HOME/.local/bin:$PATH
    - travis_retry curl -L https://get.haskellstack.org/stable/linux-x86_64.tar.gz
      | tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack'
    - stack setup
  - stage: Build dependencies
    script:
    - export PATH=$HOME/.local/bin:$PATH
    - stack build --dependencies-only
  - stage: Build Backend
    script:
    - export PATH=$HOME/.local/bin:$PATH
    - stack build
  - stage: Test Backend
    script:
    - export PATH=$HOME/.local/bin:$PATH
    - stack test
  - stage: Build and Push Docker image
    script:
    - stack build --local-bin-path ./deploy/bin/ --copy-bins
    - cd ./deploy
    - docker build -t dkurilo/library-api .
    - ./docker_push
    on:
      branch: master
