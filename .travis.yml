dist: bionic
services:
- docker
cache:
  directories:
  - "$HOME/.local/bin"
  - "$HOME/.stack"
  - "$TRAVIS_BUILD_DIR/.stack-work"
addons:
  apt:
    update: true
    packages:
    - libgmp-dev
env:
  global:
  - secure: Kcw0OzIRh9bP7+jelVt0/c+OgSHYhRhCfy/dRhyq0uYfShrP8P9EE0y4tbnBj0uEUbefl1e3mxwbtPD/EppUTuSPlHa1pCH223rwLSTHaAJMm/Nt+H3pdTq299dUQgVg7hodPr9XL1H/bPQWNcE/d+VY1dFVXwDTSYjFwg1DImFiL2DULb2OxD05lm7Ezry7TFQyrjiYczzDAfAcUDPpuPyR/vV1faKeLnIGlZcl40whm3vgZ2boi8R9FzBzGntB0yQu3BIU6ZmPLnZ7GzjBJMNsslOeqyKHa9q3MHezrj4E2AQiV6hKV7cxHQn4Sv+FAFA1vrpPTRegFLINbbcmdC+8K9Du1q8d5ryaEhaMsohoIs0b6CRdYZUO38WCVjz8gdWAe7A5J1EGvNq0gY1xjD6Bmvcvo1Y2WeaPaeHYWUAQM7YgaGdMKpmuz7NN9qDRu9E5fQQhRBAfwVLClLJltvNuOL2TiP98KNKz2y9huIrLt+8xhptiA+LNefrpEgKvqNlvyv3jMx1k4WbkZmhj6+0kPthcJsinVGhDFfGzcIiuMJ4TA4hbLqw8Xk/bsCov1q8rI9DjqKyNpTOzdiqe35bNSMDO0hD5XZ0FdU2zjgq0Ne4kSm2Y6KpGCRtefRj5InOMu9E3BHVKhSXiOqjFPR+dpYofKor1h3sSg1lfRRY=
  - secure: wYLvrnPmv1oVvZzCvGQE/bBNAfySB81ZY3diU6XHLf8pM4olTfeE5y39YMUkLrs/HK/rM/BmBG7VKx1/FF0Pgwbv3j6w+HXdBaC8YFekaFMMaUCaWP0rDOa2PiFCqUhjf/lp0unoQaTEaCD9B+6D5SjCDRX++x+fG1VMr77xo1jE0WG0LdDq4JJMslg2tO2hqNCdQTOlVcKPToSntZjDXTCgABL53UFoFmlQEq+XiRW5BTSwBMvyPHgBnqaBqSSWn58IxrPI6BsC8reqJFnBQer6b9HsKqbQbqIa09mncAnrgTLL9LK4eBmUDJh3/vJA9siN92/KKuZkUD6RUzPlptgmDVHCV6IDlDluh6EGvXJyJP8czl9hYzM8y+475XAiujh+3RxMWCeigN6JbeBvPzM+pwrd0IkKmXhsEbLP1eD8lkXvt+CAFz5bgCeetYqgulKXjR6kkxUtd3E+NvWlGfZQGAwFbEPduy9fdFDKMndYJ8uDRwbyhzjkAPOp10hXGje1geiutL0096TwWdPW6WDToAw2YTDMSzIIerSccykEst5WogeYFK74dN1bAsltCqhGgEi2867RXNkQx2O4Axi5XZkh9vS2jtsOllf+2a63+Io3DnHUCEPyRfUy8QkRHbri4o8mh5cod1NGw+DrzXcCJGusLUEPrWI7AbKE5sU=
jobs:
  include:
  - stage: Install Stack
    script:
    - export DIR=~/.local/bin
    - if [ ! -d "$DIR" ]; then mkdir -p ~/.local/bin; fi
    - export PATH=$HOME/.local/bin:$PATH
    - travis_retry curl -L https://get.haskellstack.org/stable/linux-x86_64.tar.gz
      | tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack'
    - stack setup
  - stage: Build dependencies
    script:
    - export PATH=$HOME/.local/bin:$PATH
    - stack build --dependencies-only
  - stage: Build Backend
    script:
    - export PATH=$HOME/.local/bin:$PATH
    - stack build
  - stage: Test Backend
    script:
    - export PATH=$HOME/.local/bin:$PATH
    - stack test
  - stage: Build Docker image
    script:
    - stack build --local-bin-path ./deploy/bin/ --copy-bins
    - cd ./deploy
    - docker build -t dkurilo/library-api .
    on:
      branch: master
  - stage: Push Docker Image
    provider: script
    script: bash ./deploy/docker_push
    on:
      branch: master
